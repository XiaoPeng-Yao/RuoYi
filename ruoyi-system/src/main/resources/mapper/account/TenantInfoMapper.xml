<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.TenantInfoMapper">

    <resultMap type="TenantInfo" id="TenantInfoResult">
        <result property="idTenantInfo"    column="id_tenant_info"    />
        <result property="receiverAddress"    column="receiver_address"    />
        <result property="monitorAddress"    column="monitor_address"    />
        <result property="energyBusiType"    column="energy_busi_type"    />
        <result property="price"    column="price"    />
        <result property="transferCount"    column="transfer_count"    />
        <result property="exchangeUnit"    column="exchange_unit"    />
        <result property="txId"    column="tx_id"    />
        <result property="exchangeAmount"    column="exchange_amount"    />
        <result property="isPaid"    column="is_paid"    />
        <result property="period"    column="period"    />
        <result property="userId"    column="user_id"    />
        <result property="status"    column="status"    />
        <result property="delegatedDays"    column="delegated_days"    />
        <result property="totalCountUsed"    column="total_count_used"    />
        <result property="calcRule"    column="calc_rule"    />
        <result property="remark"    column="remark"    />
        <result property="fcd"    column="fcd"    />
        <result property="fcu"    column="fcu"    />
        <result property="lcd"    column="lcd"    />
        <result property="lcu"    column="lcu"    />
    </resultMap>

    <sql id="selectTenantInfoVo">
        select id_tenant_info, receiver_address, monitor_address, energy_busi_type,price, transfer_count, exchange_unit, tx_id, exchange_amount, is_paid, period, t.user_id, t.status, delegated_days, total_count_used, calc_rule, t.remark,fcd, fcu, lcd, lcu from tenant_info t
    </sql>

    <select id="selectTenantInfoList" parameterType="TenantInfo" resultMap="TenantInfoResult">
        <include refid="selectTenantInfoVo"/>
        left join sys_user  u on t.user_id = u.user_id
        <where> 1 = 1
            <if test="receiverAddress != null  and receiverAddress != ''"> and receiver_address = #{receiverAddress}</if>
            <if test="monitorAddress != null  and monitorAddress != ''"> and monitor_address = #{monitorAddress}</if>
            <if test="energyBusiType != null  and energyBusiType != ''"> and energy_busi_type = #{energyBusiType}</if>
            <if test="price != null "> and price = #{price}</if>
            <if test="transferCount != null "> and transfer_count = #{transferCount}</if>
            <if test="exchangeUnit != null  and exchangeUnit != ''"> and exchange_unit = #{exchangeUnit}</if>
            <if test="txId != null  and txId != ''"> and tx_id = #{txId}</if>
            <if test="exchangeAmount != null "> and exchange_amount = #{exchangeAmount}</if>
            <if test="isPaid != null  and isPaid != ''"> and is_paid = #{isPaid}</if>
            <if test="status != null and status != ''" >and t.status = #{status}</if>
            <if test="period != null "> and period = #{period}</if>
            <if test="calcRule != null  and calcRule != ''"> and calc_rule = #{calcRule}</if>
            <if test="params.beginFcd != null and params.beginFcd != '' and params.endFcd != null and params.endFcd != ''"> and fcd between #{params.beginFcd} and #{params.endFcd}</if>
            <if test="fcu != null  and fcu != ''"> and fcu = #{fcu}</if>
            <if test="lcd != null "> and lcd = #{lcd}</if>
            <if test="lcu != null  and lcu != ''"> and lcu = #{lcu}</if>
        </where>

        <!-- 数据范围过滤 -->
        ${params.dataScope}

    </select>

    <select id="selectTenantInfoByIdTenantInfo" parameterType="Long" resultMap="TenantInfoResult">
        <include refid="selectTenantInfoVo"/>
        where id_tenant_info = #{idTenantInfo}
    </select>


    <insert id="insertTenantInfo" parameterType="TenantInfo" useGeneratedKeys="true" keyProperty="idTenantInfo">
        insert into tenant_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="receiverAddress != null and receiverAddress != ''">receiver_address,</if>
            <if test="monitorAddress != null">monitor_address,</if>
            <if test="energyBusiType != null">energy_busi_type,</if>
            <if test="price != null">price,</if>
            <if test="transferCount != null">transfer_count,</if>
            <if test="exchangeUnit != null">exchange_unit,</if>
            <if test="txId != null">tx_id,</if>
            <if test="exchangeAmount != null">exchange_amount,</if>
            <if test="isPaid != null">is_paid,</if>
            <if test="period != null">period,</if>
            <if test="userId != null">user_id,</if>
            <if test="status != null">status,</if>
            <if test="delegatedDays != null">delegated_days,</if>
            <if test="totalCountUsed != null">total_count_used,</if>
            <if test="calcRule != null">calc_rule,</if>
            <if test="remark != null">remark,</if>
            <if test="fcd != null">fcd,</if>
            <if test="fcu != null">fcu,</if>
            <if test="lcd != null">lcd,</if>
            <if test="lcu != null">lcu,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="receiverAddress != null and receiverAddress != ''">#{receiverAddress},</if>
            <if test="monitorAddress != null">#{monitorAddress},</if>
            <if test="energyBusiType != null">#{energyBusiType},</if>
            <if test="price != null">#{price},</if>
            <if test="transferCount != null">#{transferCount},</if>
            <if test="exchangeUnit != null">#{exchangeUnit},</if>
            <if test="txId != null">#{txId},</if>
            <if test="exchangeAmount != null">#{exchangeAmount},</if>
            <if test="isPaid != null">#{isPaid},</if>
            <if test="period != null">#{period},</if>
            <if test="userId != null">#{userId},</if>
            <if test="status != null">#{status},</if>
            <if test="delegatedDays != null">#{delegatedDays},</if>
            <if test="totalCountUsed != null">#{totalCountUsed},</if>
            <if test="calcRule != null">#{calcRule},</if>
            <if test="remark != null">#{remark},</if>
            <if test="fcd != null">#{fcd},</if>
            <if test="fcu != null">#{fcu},</if>
            <if test="lcd != null">#{lcd},</if>
            <if test="lcu != null">#{lcu},</if>
        </trim>
    </insert>

    <update id="updateTenantInfo" parameterType="TenantInfo">
        update tenant_info
        <trim prefix="SET" suffixOverrides=",">
            <if test="receiverAddress != null and receiverAddress != ''">receiver_address = #{receiverAddress},</if>
            <if test="monitorAddress != null">monitor_address = #{monitorAddress},</if>
            <if test="energyBusiType != null">energy_busi_type = #{energyBusiType},</if>
            <if test="price != null">price = #{price},</if>
            <if test="transferCount != null">transfer_count = #{transferCount},</if>
            <if test="exchangeUnit != null">exchange_unit = #{exchangeUnit},</if>
            <if test="txId != null">tx_id = #{txId},</if>
            <if test="exchangeAmount != null">exchange_amount = #{exchangeAmount},</if>
            <if test="isPaid != null">is_paid = #{isPaid},</if>
            <if test="period != null">period = #{period},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="delegatedDays != null">delegated_days = #{delegatedDays},</if>
            <if test="totalCountUsed != null">total_count_used = #{totalCountUsed},</if>
            <if test="calcRule != null">calc_rule = #{calcRule},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="fcd != null">fcd = #{fcd},</if>
            <if test="fcu != null">fcu = #{fcu},</if>
            <if test="lcd != null">lcd = #{lcd},</if>
            <if test="lcu != null">lcu = #{lcu},</if>
        </trim>
        where id_tenant_info = #{idTenantInfo}
    </update>

    <delete id="deleteTenantInfoByIdTenantInfo" parameterType="Long">
        delete from tenant_info where id_tenant_info = #{idTenantInfo}
    </delete>

    <delete id="deleteTenantInfoByIdTenantInfos" parameterType="String">
        delete from tenant_info where id_tenant_info in
        <foreach item="idTenantInfo" collection="array" open="(" separator="," close=")">
            #{idTenantInfo}
        </foreach>
    </delete>

    <select id="selectTenantInfoListNotExistsInExchange" parameterType="TenantInfo" resultMap="TenantInfoResult">
        <include refid="selectTenantInfoVo"/>
        <where>
            <if test="status != null and status != ''">
                and t.status = #{status}
            </if>
            and not exists(select 1
                           from trx_exchange_info te
                           where t.receiver_address = te.from_address
                             and t.energy_busi_type = te.energy_busi_type
                             and te.delegate_status = '0')
        </where>
    </select>
</mapper>