<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.busi.mapper.BusiTaskMapper">
    
    <resultMap type="BusiTask" id="BusiTaskResult">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="orderName"    column="order_name"    />
        <result property="prisonLineId"    column="prison_line_id"    />
        <result property="lineName"    column="line_name"    />
        <result property="taskName"    column="task_name"    />
        <result property="targetAmount"    column="target_amount"    />
        <result property="completedAmount"    column="completed_amount"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="status"    column="status"    />
    </resultMap>

    <resultMap id="BusiTaskBusiSubTaskResult" type="BusiTask" extends="BusiTaskResult">
        <collection property="busiSubTaskList" notNullColumn="sub_id" javaType="java.util.List" resultMap="BusiSubTaskResult" />
    </resultMap>

    <resultMap type="BusiSubTask" id="BusiSubTaskResult">
        <result property="id"    column="sub_id"    />
        <result property="taskId"    column="sub_task_id"    />
        <result property="productRequireId"    column="sub_product_require_id"    />
        <result property="size"    column="sub_size"    />
        <result property="color"    column="sub_color"    />
        <result property="targetAmount"    column="sub_target_amount"    />
        <result property="completedAmount"    column="sub_completed_amount"    />
        <result property="createBy"    column="sub_create_by"    />
        <result property="createTime"    column="sub_create_time"    />
        <result property="status"    column="sub_status"    />
    </resultMap>

    <select id="selectBusiTaskList" parameterType="BusiTask" resultMap="BusiTaskResult">
        SELECT bt.id,bo.order_name,bpl.disname line_name,bt.task_name,bst.target_amount,bst.completed_amount,bt.status FROM busi_task bt
        left join busi_order bo on bt.order_id = bo.id
        left join busi_prison_line bpl on bt.prison_line_id = bpl.id
        left join
        (SELECT max(task_id) task_id,sum(target_amount) target_amount,sum(completed_amount) completed_amount from busi_sub_task GROUP BY task_id) bst
        on bst.task_id = bt.id
        <where>  
            <if test="orderId != null  and orderId != ''"> and bt.order_id = #{orderId}</if>
            <if test="prisonLineId != null  and prisonLineId != ''"> and bt.prison_line_id = #{prisonLineId}</if>
            <if test="taskName != null  and taskName != ''"> and bt.task_name like concat('%', #{taskName}, '%')</if>
            <if test="status != null  and status != ''"> and bt.status = #{status}</if>
        </where>
    </select>
    
    <select id="selectBusiTaskById" parameterType="String" resultMap="BusiTaskBusiSubTaskResult">
        select a.id, a.order_id,bpl.disname line_name,bo.order_name, a.prison_line_id, a.task_name, a.create_by, a.create_time, a.update_by, a.update_time, a.status,
            b.id as sub_id, b.task_id as sub_task_id, b.product_require_id as sub_product_require_id, b.target_amount as sub_target_amount, b.completed_amount as sub_completed_amount,
               bpr.color as sub_color,bpr.size as sub_size,b.create_by as sub_create_by, b.create_time as sub_create_time, b.status as sub_status
        from busi_task a
        LEFT JOIN busi_order bo on a.order_id = bo.id
        LEFT JOIN busi_prison_line bpl on a.prison_line_id = bpl.id
        left join busi_sub_task b on b.task_id = a.id
        LEFT JOIN busi_product_require bpr on bpr.id = b.product_require_id
        where a.id = #{id}
    </select>
        
    <insert id="insertBusiTask" parameterType="BusiTask" useGeneratedKeys="true" keyProperty="id">
        insert into busi_task
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderId != null and orderId != ''">order_id,</if>
            <if test="prisonLineId != null and prisonLineId != ''">prison_line_id,</if>
            <if test="taskName != null">task_name,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="status != null and status != ''">status,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderId != null and orderId != ''">#{orderId},</if>
            <if test="prisonLineId != null and prisonLineId != ''">#{prisonLineId},</if>
            <if test="taskName != null">#{taskName},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="status != null and status != ''">#{status},</if>
         </trim>
    </insert>

    <update id="updateBusiTask" parameterType="BusiTask">
        update busi_task
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderId != null and orderId != ''">order_id = #{orderId},</if>
            <if test="prisonLineId != null and prisonLineId != ''">prison_line_id = #{prisonLineId},</if>
            <if test="taskName != null">task_name = #{taskName},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="status != null and status != ''">status = #{status},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteBusiTaskById" parameterType="String">
        delete from busi_task where id = #{id}
    </delete>

    <delete id="deleteBusiTaskByIds" parameterType="String">
        delete from busi_task where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <delete id="deleteBusiSubTaskByTaskIds" parameterType="String">
        delete from busi_sub_task where task_id in 
        <foreach item="taskId" collection="array" open="(" separator="," close=")">
            #{taskId}
        </foreach>
    </delete>

    <delete id="deleteBusiSubTaskByTaskId" parameterType="String">
        delete from busi_sub_task where task_id = #{taskId}
    </delete>

    <insert id="batchBusiSubTask">
        insert into busi_sub_task( id, task_id, product_require_id, target_amount, completed_amount, create_by, create_time, status) values
		<foreach item="item" index="index" collection="list" separator=",">
            ( #{item.id}, #{item.taskId}, #{item.productRequireId}, #{item.targetAmount}, #{item.completedAmount}, #{item.createBy}, #{item.createTime}, #{item.status})
        </foreach>
    </insert>


    <select id="selectProductRequire" parameterType="String" resultType="java.util.Map">
        SELECT bpr.id productRequireId,bpr.size,bpr.color,bpr.amount requireAmount,bst.target_amount assignedAmount  FROM busi_product_require bpr
        left join
        (SELECT max(product_require_id) product_require_id,sum(target_amount) target_amount from busi_sub_task GROUP BY product_require_id) bst
        on bst.product_require_id = bpr.id
         WHERE bpr.order_id = #{orderId}
    </select>

</mapper>