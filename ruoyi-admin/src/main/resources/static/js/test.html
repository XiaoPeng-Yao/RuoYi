<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Demo page</title>
</head>
<body>
<p></p>

<div class="demo">
    <div>
        <span id="code"></span>
    </div>
    <button id="btn" onclick="addText(150,12,2)">添加文字</button>
    <button id="print" onclick="print()">打印</button>
</div>

<script src="jquery.min.js"></script>
<script type="text/javascript" src="qrcode.js"></script>
<script type="text/javascript" src="jquery.qrcode.js"></script>
<script>
    var arr = [];//作为全局变量，可以通过遍历数组来实现批量生成二维码功能
    arr.push(['1区1线|HS0001|XXXXS|红色|30', '1区1线|HS001|XXS|红色|30'])
    // arr.push(['https://http://www.sina.com.cn/','新浪'])

    $(function () {
        for (var i = 0; i < arr.length; i++) {
            var urlstr = arr[i][0];
            console.log(urlstr)
            $("#code").qrcode({
                render: "canvas",
                width: 180,
                height: 150,
                text: toUtf8(urlstr),
                foreground: "#FE007F" //前景颜色
            });
        }
        addText();
    })

    function addText(text, canvassize = 150, fontsize = 12, padding = 1, divBackground = "#fff", fontColor = "#a50054") {
        var canvases = document.getElementsByTagName('canvas');
        var fontsizeH = fontsize + padding * 3;         //文字高度
        var rectW = 0;                              //长方形背景宽度
        var width = 0;
        var centerx = canvassize / 2 - rectW / 2;       //居中的x
        var centery = canvassize / 2 - fontsizeH / 2;   //居中的y
        for (var i = 0; i < canvases.length; i++) {
            var ctx = canvases[i].getContext("2d");
            width = ctx.measureText(arr[i][1]).width; //文字长度,不知道为什么这里的width是中文字数的10倍，故需要乘上fontsize/10获取到真实的文字宽度
            rectW = width * fontsize / 10 + padding * 2;      //长方形背景宽度，应左右留padding
            centerx = canvassize / 2 - rectW / 2;         //长方形背景居中的x
            centery = canvassize / 2 - fontsizeH / 2      //长方形背景居中的y
            ctx.fillStyle = divBackground;              //长方形背景颜色
            ctx.fillRect(centerx + 10, centery, rectW, fontsizeH);
            ctx.font = fontsize + "px Calibri";         //设置文字大小
            ctx.fillStyle = fontColor;
            ctx.fillText(arr[i][1], centerx + padding + 10, centery + fontsize + padding / 2)
            //经测试，若参数y只填centery，则文字显示在长方形背景的上边，所以需要加上fontsize长方形背景才能包裹文字
        }
    }

    function toUtf8(str) {
        var out, i, len, c;
        out = "";
        len = str.length;
        for (i = 0; i < len; i++) {
            c = str.charCodeAt(i);
            if ((c >= 0x0001) && (c <= 0x007F)) {
                out += str.charAt(i);
            } else if (c > 0x07FF) {
                out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
                out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F));
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
            } else {
                out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F));
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
            }
        }
        return out;
    }

    function printNewWindow() {
        var canvas = document.getElementsByTagName("canvas")[0];  /// get canvas element
        var imgSrc = canvas.toDataURL();
        let oWin = window.open('', 'pringwindow', 'menubar=no,location=no,resizable=yes,scrollbars=no,status=no,width=600,height=400')
        oWin.document.fn = function () {
            if (oWin) {
                oWin.print()
                oWin.close()
            }
        }
        let html = '<div style="height: 100%;width: 100%;">' + `<img src="${imgSrc}" onload="fn()" style="max-height:100%;max-width: 100%;" />` + '</div>'
        oWin.document.open()
        oWin.document.write(html)
        oWin.document.close()
    }
</script>

</body>
</html>