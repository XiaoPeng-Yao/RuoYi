<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
	<th:block th:include="include :: header('结果下载')" />
	<th:block th:include="include :: layout-latest-css" />
</head>
<body class="gray-bg">
	<div class="container-div">
		<div class="row">
			<div class="col-sm-12 search-collapse">
				<form id="project-result-download-form">
					<div class="select-list">
						<ul>
							<li>
								项目名：<input type="text" name="projectName"/>
							</li>
							<li>
								上传人：<select name="username" >
											<option value="">--请选择--</option>
											<option th:each="user : ${users}" th:text="${user.username}" th:value="${user.username}"></option>
										</select>
							</li>
							<li>
								状态：<select name="state" >
										<option value="">--请选择--</option>
										<option value="在查">在查</option>
										<option value="待查">待查</option>
										<option value="暂停">暂停</option>
									</select>
							</li>
							<li class="select-time">
								<label>上传时间： </label>
								<input type="text" class="time-input" id="startSubmitTime" placeholder="开始时间" name="startSubmitTime" readOnly/>
								<span>-</span>
								<input type="text" class="time-input" id="endSubmitTime" placeholder="结束时间" name="endSubmitTime" readOnly/>
							</li>
							<li>
								<a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
							    <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
							</li>
						</ul>
					</div>
				</form>
			</div>
		
			<div class="btn-group-sm" id="toolbar" role="group">
				<a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()" >
		            <i class="fa fa-remove"></i> 删除
		        </a>
				<a class="btn btn-danger multiple disabled" onclick="$.operate.recheckProjects(-1)" >
					<i class="fa fa-play"></i> 再查
				</a>
	        </div>
	        
	        <div class="col-sm-12 select-table table-striped">
			    <table id="bootstrap-table"></table>
			</div>
		</div>
	</div>
	<th:block th:include="include :: footer" />
	<script th:inline="javascript">
		var prefix = ctx + "project.do";

		$(function() {
		    var options = {
		        url: prefix + "/queryProject?queryType=resultDownload",
		        removeUrl: prefix + "/delete",
				recheckUrl: prefix + "/recheck",
		        sortName: "roleSort",
		        modalName: "用户",
		        columns: [
					{
		            checkbox: true
		        },
		        {
		            field: 'id',
					visible: false
		        },
		        {
		            field: 'realOrder',
		            title: '任务编号',
		            sortable: false,
					formatter: function (value, row, index) {
						var currentPage = $("#bootstrap-table").bootstrapTable("getOptions").pageNumber;
						var pageSize = $("#bootstrap-table").bootstrapTable("getOptions").pageSize;
						return (pageSize * (currentPage - 1) ) + (index + 1);
					}
		        },
				{
					field: 'projectName',
					title: '项目名',
					sortable: true
				},
				{
					field: 'version',
					title: '版本',
					sortable: true
				},
				{
					field: 'submitUserName',
					title: '上传人',
					sortable: true
				},
				{
					field: 'pcbFile',
					title: '文件名',
					sortable: false,
					formatter: function (value, row, index) {
						var html="";
						html += "<span>PCB文件:</span><A href='javascript:getFile(\""+ row.pcbFile + "\");'>"+ row.pcbFileName +"</A></br>";
						html += "<span>BOM文件:</span><A href='javascript:getFile(\""+ row.bomFile + "\");'>"+ row.bomFileName +"</A></br>";
						var fid;
						if(0 != row.pcbFile) {
							fid = row.pcbFile;
						} else if(0 != row.bomFile) {
							fid = row.bomFile;
						}
						var paramFile = row.projectName + "_" + row.version + ".param";
						html += "<span >参数文件:</span><A href=\"javascript:getParamFile(" + fid +",'" + paramFile +"');\">"+ paramFile +"</A>";
						return html;
					}
				},
		        {
		            field: 'submitTime',
		            title: '上传时间',
		            sortable: true
		        },
				{
					field: 'endTime',
					title: '完成时间',
					sortable: true
				},
				{
					field: 'state',
					title: '状态',
					sortable: true
				},{
					field: 'runTime',
					title: '运行时长(分钟)',
					sortable: true
				},{
					field: 'downloadResult',
					title: '结果下载/反馈',
					sortable: false,
					formatter: function (value, row, index) {
						return getDownloadResultHtml(row);
					}
				},
				{
					field: 'remark',
					title: '备注',
					sortable: false
				},
		        {
		            title: '操作',
		            align: 'center',
		            formatter: function(value, row, index) {
		                var actions = [];
		                actions.push('<a class="btn btn-danger btn-xs" href="javascript:void(0)" onclick="$.operate.remove(' + row.id + ')"><i class="fa fa-remove"></i>删除</a> ');
						actions.push('<a class="btn btn-danger btn-xs" href="javascript:void(0)" onclick="$.operate.recheckProjects(' + row.id + ')"><i class="fa fa-play"></i>再查</a> ');
		                return actions.join('');
		            }
		        }
		        ]
		    };
		    $.table.init(options);
		});

		//下载文件
		function getFile(fid)
		{
			// document.location.href='file.do/download?fid=' + fid;
			var url = ctx + 'file.do/download?fid=' + fid;
			window.location.href = url;
		}

		//下载参数文件
		function getParamFile(fid,fname)
		{
			// document.location.href='project.do/downloadParamFile&fid=' + fid + '&fname=' + encodeURI(fname);
			var url = ctx + 'project.do/downloadParamFile?fid=' + fid + '&fname=' + encodeURI(fname);
			window.location.href = url;
		}

		//下载结果文件
		function getResultFile(fid,fname)
		{
			var url = ctx + 'project.do/downloadResultFile?fid=' + fid + '&fname=' + encodeURI(fname);
			// document.location.href='project.do?method=downloadResultFile&fid=' + fid + '&fname=' + encodeURI(fname);
			window.location.href = url;
		}

		/**
		 * 生成下载结果文件表格内容
		 */
		function getDownloadResultHtml(project){
			var fid;
			if(0 != project.pcbFile) {
				fid = project.pcbFile;
			} else if(0 != project.bomFile) {
				fid = project.bomFile;
			}

			var preDFMFileId = project.preDFMFileId;
			var postDFMFileId = project.postDFMFileId;
			var preDFMFileName = project.preDFMFileName;
			var postDFMFileName = project.postDFMFileName;
			var resultFile = project.resultFile;
			var id = project.id;


			var preDFMFileIdHtml="";
			if(0!=preDFMFileId){
				preDFMFileIdHtml+="<A href=\"javascript:getFile("+preDFMFileId+");\">"+preDFMFileName+"</A>";
			}

			var postDFMFileIdHtml="";
			if(0!=postDFMFileId){
				postDFMFileIdHtml+="<A href=\"javascript:getFile("+postDFMFileId+");\">"+postDFMFileName+"</A>";
			}

			var html = "<table width=\"300\" style=\"table-layout: fixed;\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">" +
					"            <tr>" +
					"                <td colspan=\"2\" align=\"left\" style=\"text-overflow: ellipsis;overflow: hidden;white-space: nowrap;\">" +
					"                    <A href=\"javascript:getResultFile(" + fid +",'"+resultFile+"');\">"+resultFile+"</A>" +
					"                </td>" +
					"            </tr>" +
					"            <tr>" +
					"                <td align=\"left\" width=80% style=\"text-overflow: ellipsis;overflow: hidden;white-space: nowrap;\">" +
					"                    <span id=\"downloadPreDFMFile_"+id+"\">" +
										preDFMFileIdHtml +
					"					</span>" +
					"                </td>" +
					"                <td align=\"right\" width=20%>" +
					"                    <input type=\"file\" id=\"preDFMFile_"+ id +"\" name=\"preDFMFile\" style=\"display:none\"/>" +
					"                    <input id=\"uploadPreDFM\" type=\"button\" value=\"Pre-DFM\" onclick=\"uploadDFM("+id+",'pre')\"  style=\"width:80px;\"/>&nbsp;" +
					"                </td>" +
					"            </tr>" +
					"            <tr>" +
					"                <td width=80% align=\"left\" style=\"text-overflow: ellipsis;overflow: hidden;white-space: nowrap;\">" +
					"                    <span id=\"downloadPostDFMFile_"+id+"\">" +
											postDFMFileIdHtml +
					"					</span>" +
					"                </td>" +
					"                <td align=\"right\" width=20%>" +
					"                    <!-- 上传PostDFM -->" +
					"                    <input type=\"file\" id=\"postDFMFile_"+ id +"\" name=\"postDFMFile\" style=\"display:none\"/>" +
					"                    <input id=\"uploadPostDFM\" type=\"button\" value=\"Post-DFM\"  onclick=\"uploadDFM("+id+",'post')\" style=\"width:80px;\"/>&nbsp;" +
					"                </td>" +
					"            </tr>" +
					"        </table>";
			return html;
		}


		//异步上传DFM文件
		function uploadDFM(pid, dfm) {
			var url = prefix;
			var fileName;
			if('pre' == dfm) {
				url += "/uploadPreDFM";
				fileName = "preDFMFile";
			} else if('post' == dfm) {
				url += "/uploadPostDFM";
				fileName = "postDFMFile";
			}

			var fileInput = $("#" + fileName + "_" + pid)[0];

			$(fileInput).on("change", function () {
				var formData = new FormData();
				formData.append('pid', pid);
				formData.append(fileName, fileInput.files[0]);

				$.ajax({
					url: url,
					type: 'post',
					cache: false,
					data: formData,
					processData: false,
					contentType: false,
					dataType: "json",
					beforeSend: function () {
						$.modal.loading("正在处理中，请稍后...");
						$.modal.disable();
					},
					success: function(result) {
						$.modal.closeLoading();
						if(null != result && 0 == result.code) {
							var fid = result.data.fid;
							var fname = result.data.fname;
							uploadCallback(fileName,"上传成功", fid, fname, pid);
						} else {
							$.modal.alertSuccess("上传失败");
						}
					}
				});
			});
			$(fileInput).click();

		}

		/**
		 * 异步上传文件回调
		 **/
		function uploadCallback(uploadType, uploadResult, fid, fname, pid){
			$.modal.alertSuccess(uploadResult);
			if("上传成功" == uploadResult) {
				var spanId;
				var downloadLink = "<A href=\"javascript:getFile("+ fid +");\">" + fname + "</A>";
				if("preDFMFile" == uploadType) {
					spanId = "#downloadPreDFMFile_" + pid;
				} else if("postDFMFile" == uploadType) {
					spanId = "#downloadPostDFMFile_" + pid;
				}
				$(spanId).html(downloadLink);
			}
		}


		function myBrowser() {
			var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
			var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
			var isIE = userAgent.indexOf("compatible") > -1
					&& userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
			var isEdge = userAgent.indexOf("Edge") > -1; //判断是否IE的Edge浏览器
			var isFF = userAgent.indexOf("Firefox") > -1; //判断是否Firefox浏览器
			var isSafari = userAgent.indexOf("Safari") > -1
					&& userAgent.indexOf("Chrome") == -1; //判断是否Safari浏览器
			var isChrome = userAgent.indexOf("Chrome") > -1
					&& userAgent.indexOf("Safari") > -1; //判断Chrome浏览器

			if (isIE) {
				var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
				reIE.test(userAgent);
				var fIEVersion = parseFloat(RegExp["$1"]);
				if (fIEVersion == 7) {
					return "IE7";
				} else if (fIEVersion == 8) {
					return "IE8";
				} else if (fIEVersion == 9) {
					return "IE9";
				} else if (fIEVersion == 10) {
					return "IE10";
				} else if (fIEVersion == 11) {
					return "IE11";
				} else {
					return "0";
				}//IE版本过低
				return "IE";
			}
			if (isOpera) {
				return "Opera";
			}
			if (isEdge) {
				return "Edge";
			}
			if (isFF) {
				return "FF";
			}
			if (isSafari) {
				return "Safari";
			}
			if (isChrome) {
				return "Chrome";
			}

		}



	</script>


</body>
</html>