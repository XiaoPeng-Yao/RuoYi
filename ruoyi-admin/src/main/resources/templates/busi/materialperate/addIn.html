<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增来料')" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-materialperate-add">
        <input name="oprateType" type="hidden" th:value="${operType}">

        <div class="form-group">
            <label class="col-sm-3 control-label is-required">订单：</label>
            <div class="col-sm-8">
                <input id="treeId" name="orderId"  type="hidden">
                <input  id="treeName" name="orderName" readonly="true" onclick="selectOrder(1)"  class="form-control" type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required" title="若无对应的物料选项，请先在产品需求中添加物料需求">物料选择：<i class="fa fa-question-circle-o"></i></label>
            <div class="col-sm-4">
                <select id="classify" name="classify" class="form-control required" >
                </select>
            </div>
            <div class="col-sm-4">
                <select id="color" name="color" class="form-control required" >
                </select>
            </div>
<!--            <label class="control-label text-danger">需求量：<span id="requireAmount" class=""> &#45;&#45; </span></label>-->
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">数量：</label>
            <div class="col-sm-8">
                <input name="amount" class="form-control" type="text" required>
            </div>
<!--            <label class="control-label text-danger">当前库存量：<span id="requireAmount" class=""> &#45;&#45; </span></label>-->
        </div>
<!--        <div class="form-group" th:style="${operType==null}?'':'display:none'">-->
<!--            <label class="col-sm-3 control-label">操作类型：</label>-->
<!--            <div class="col-sm-8">-->
<!--                <select name="oprateType" class="form-control m-b">-->
<!--                    <option value="1" th:selected="${operType ne '2'}">入库</option>-->
<!--                    <option value="2" th:selected="${operType eq '2'}">出库</option>-->
<!--                </select>-->
<!--            </div>-->
<!--        </div>-->
        <div class="form-group">
            <label class="col-sm-3 control-label">备注信息：</label>
            <div class="col-sm-8">
                <textarea name="remark" class="form-control"></textarea>
            </div>
        </div>

        <div class="form-group" th:if="${inTab!=null}">
            <div class="col-sm-5"></div>
            <div class="col-sm-2">
                <a class="btn btn-success" onclick="submitHandler()" >
                    保存
                </a>
            </div>
            <div class="col-sm-3">
                <a class="btn btn-info" onclick="$.modal.closeTab()" >
                    关闭
                </a>
            </div>
    </form>
</div>
<th:block th:include="include :: footer" />
<script th:inline="javascript">
    var prefix = ctx + "busi/materialperate";
    var colorDatas = [[${@dict.getType('busi_color')}]];
    var sizeDatas = [[${@dict.getType('busi_size')}]];
    var classifyDatas = [[${@dict.getType('busi_material_type')}]];

    $("#form-materialperate-add").validate({
        focusCleanup: true
    });

    $("#classify").change(function(){
        var orderId = $("#treeId").val();
        var classify = $("#classify").val();
        queryColorList(orderId, classify);
    })

    function submitHandler() {
        if ($.validate.form()) {
            $.operate.save(prefix + "/add", $('#form-materialperate-add').serialize());
        }
    }

    /*订单选择*/
    function selectOrder(status) {
        var options = {
            title: '选择订单',
            width: "480",
            height: "500",
            url: ctx + "busi/order/selectOrder/" + status,
            callBack: function(index, layero){
                var body = $.modal.getChildFrame(index);
                $("#treeId").val(body.find('#treeId').val());
                $("#treeName").val(body.find('#treeName').val());
                $.modal.close(index);
                queryClassifyList(body.find('#treeId').val());
            }
        };
        $.modal.openOptions(options);
    }

    /*物料需求类型查询*/
    function queryClassifyList(orderId) {
        var url = ctx + "busi/productRequire/selMaterialTypeListByOrderId?orderId=" + orderId;
        $.operate.ajaxPost(url, {}, function (result) {
            var data = result.data;
            $("#color").empty();
            $("#classify").empty().append("<option  value=''>请选择物料</option>");
            for (var i = 0; i < data.length; i++) {
                var val = data[i].classifyCode;
                var text = $.table.getDictText(classifyDatas, val);
                $("#classify").append("<option value='" + val + "'>" + text + "</option>");
            }
        })
    }

    /*物料需求颜色查询*/
    function queryColorList(orderId, classify) {
        var url = ctx + "busi/productRequire/selMaterialColorListByOrderIdAndType";
        $.operate.ajaxPost(url, {
            orderId:orderId,
            classify:classify
        }, function (result) {
            var data = result.data;
            $("#color").empty().append("<option  value=''>请选择颜色</option>");
            for (var i = 0; i < data.length; i++) {
                var val = data[i].colorCode;
                var text = $.table.getDictText(colorDatas, val);;
                $("#color").append("<option value='" + val + "'>" + text + "</option>");
            }
        })
    }
</script>
</body>
</html>