<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head>
    <th:block th:include="include :: header('请购单列表')" />
</head>
<body class="gray-bg">

<div class="container-div">
    <div class="row">
        <div class="col-sm-12 search-collapse">
            <form id="formId">
                <div class="select-list">
                    <ul>
                        <li>
                            编号：<input type="text" name="requisitionNo"/>
                        </li>

                        <li>
                            员工编号：<input type="text" name="employeeNo"/>
                        </li>

                        <li>
                            员工姓名：<input type="text" name="userName"/>
                        </li>

                        <li>
                            部门：<input type="text" name="userDepartment"/>
                        </li>

                        <li>
                            公司：
                            <select name="company">
                                <option value="">ALL</option>
                                <option value="5">杭州</option>
                                <option value="6">南京</option>
                                <option value="17">成都</option>
                                <option value="7">西安</option>
                                <option value="14">上海矽力杰微电子</option>
                                <option value="1">开曼</option>
                                <option value="19">上海</option>
                                <option value="3">韩国</option>
                                <option value="4">美国</option>
                                <option value="9">萨摩亚</option>
                                <option value="16">印度</option>
                                <option value="15">日本</option>
                                <option value="13">香港</option>
                                <option value="12">台湾矽力杰</option>
                                <option value="20">南京香港</option>
                                <option value="21">矽望</option>
                                <option value="23">合肥</option>
                                <option value="24">澳门</option>
                            </select>
                        </li>

                        <li>
                            申请类别：
                            <select name="typeOfApplication">
                                <option value="">ALL</option>
                                <option value="1">非销售性请购</option>
                                <option value="2">固定资产</option>
                            </select>
                        </li>

                        <li>
                            申请类别：
                            <select name="category">
                                <option value="">ALL</option>
                                <option value="1">预算内</option>
                                <option value="2">预算外</option>
                                <option value="3">新产品开发</option>
                                <option value="4">其他</option>
                            </select>
                        </li>

                        <li>
                            资产管理类别：
                            <select name="assetManagement">
                                <option value="">ALL</option>
                                <option value="1">测试设备类</option>
                                <option value="2">IT桌面类</option>
                                <option value="3">办公家具类</option>
                                <option value="4">实验室桌椅</option>
                                <option value="5">无(非销售性请购)</option>
                                <option value="6">元器件</option>
                                <option value="7">办公家具</option>
                                <option value="8">办公用品类</option>
                                <option value="9">工程维修改造(非销售性请购)</option>
                                <option value="10">工程维修改造(固定资产)</option>
                                <option value="11">无(固定资产)</option>
                                <option value="12">个人电脑</option>
                            </select>
                        </li>

                        <li>
                            预算申购单编号：<input type="text" name="purchaseCode"/>
                        </li>

                        <li>
                            状态：
                            <select name="status">
                                <option value="">ALL</option>
                                <option value="1">已保存待提交</option>
                                <option value="2">待主管审批</option>
                                <option value="23">待经理审批</option>
                                <option value="24">待总监审批</option>
                                <option value="25">待执行总监审批</option>
                                <option value="13">待资产管理员审批</option>
                                <option value="20">待采购代表审批</option>
                                <option value="16">待新员工入职HR审批</option>
                                <option value="19">待HR审批</option>
                                <option value="14">待预算管理员审批</option>
                                <option value="3">待总账审批</option>
                                <option value="11">待财务经理审批</option>
                                <option value="4">待总经理审批</option>
                                <option value="18">待前加签审批</option>
                                <option value="26">待后加签审批</option>
                                <option value="22">保留</option>
                                <option value="7">撤回</option>
                                <option value="6">否决</option>
                                <option value="5">完成</option>
                            </select>
                        </li>
                        <li class="select-time">
                            <label style="width: 80px">申请日期：</label>
                            <input type="text" class="time-input" name="startTime" autocomplete="off" placeholder="开始时间"/>
                            <span>-</span>
                            <input type="text" class="time-input" name="endTime" autocomplete="off" placeholder="结束时间"/>
                        </li>

                        <li>
                            <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                            <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                        </li>
                    </ul>
                </div>
            </form>
        </div>

        <div class="btn-group-sm" id="toolbar" role="group">
            <a class="btn btn-info btn-xs" onclick="batchReview()">
                <i class="fa fa-edit"></i> 批量审批
            </a>
        </div>
        
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table" data-mobile-responsive="true"></table>
        </div>
    </div>
</div>
<div th:include="include :: footer"></div>
<script th:src="@{/ajax/libs/report/peity/jquery.peity.min.js}"></script>
<script th:inline="javascript">
    var editFlag = [[${@permission.hasPermi('system:requisition:edit')}]];
    var removeFlag = [[${@permission.hasPermi('system:requisition:remove')}]];
    var detailFlag = [[${@permission.hasPermi('system:requisition:detail')}]];
    var addFlag = [[${@permission.hasPermi('system:requisition:add')}]];
    var reviewFlag = [[${@permission.hasPermi('system:requisition:review')}]];
    var prefix = ctx + "system/requisition";

    $(function() {
        var options = {
            url: prefix + "/list/todo",
            createUrl: prefix + "/add",
            updateUrl: prefix + "/edit/{id}",
            removeUrl: prefix + "/remove",
            exportUrl: prefix + "/export",
            modalName: "请购单主",
            showExport: false,
            clickToSelect: true,
            mobileResponsive: true,
            sortName: "updateTime",
            sortOrder: "desc",
            onLoadSuccess: onLoadSuccess,
            columns: [{
                checkbox: true,
            },
                {
                    field: 'id',
                    title: 'id',
                    visible: false
                },
                {
                    field : 'requisitionNo',
                    title : '编号',
                    align: 'left',
                    sortable: true,
                },
                {
                    field : 'employeeNo',
                    title : '员工编号',
                    align: 'left',
                    sortable: true
                },
                {
                    field : 'userName',
                    title : '员工姓名',
                    align: 'left',
                    sortable: true
                },
                {
                    field : 'typeOfApplication',
                    title : '申请类别',
                    align: 'left',
                    formatter: function (value, row, index) {
                        return typeTools(row);
                    }
                },
                {
                    field : 'createTime',
                    title : '申请日期',
                    align: 'left',
                    sortable: true,
                    formatter: function (value, row, index) {
                        return $.common.dateFormat(value, 'yyyy-MM-dd');
                    }
                },
                {
                    title : '文件',
                    align: 'left',
                    formatter: function(value, row, index) {
                        var actions = [];
                        var status = row.status;
                        var flag = false;
                        if (status == 1 || status == 7 || status == 13 || status == 20){
                            flag = true;
                        }
                        actions.push('<a class="btn btn-info btn-xs " href="javascript:void(0)" onclick="fileList(\'' + row.id + '\',' + flag + ')"><i class="fa fa-list-ul"></i> 列表</a>');
                        return actions.join('');
                    }
                },
                {
                    field: 'purchaseCode',
                    title: '预算申购单编号',
                    align: 'left',
                    sortable: true
                },
                {
                    field : 'createBy',
                    title : '创建人名字',
                    align: 'left',
                    sortable: true
                },
                {
                    field : 'status',
                    title : '状态',
                    align: 'left',
                    sortable: true,
                    formatter: function (value, row, index) {
                        return statusTools(row);
                    }
                },
                {
                    field : 'sendToName',
                    title : '待签核人员',
                    align: 'left',
                },
                {
                    field: 'progressRate',
                    title: '进度',
                    align: 'left',
                    formatter: function (value, row, index) {
                        if ($.common.isNotEmpty(value)) {
                            value = '<span class="pie">' + value + '</span>';
                        }
                        return value;
                    },
                },
                {
                    title: '操作',
                    align: 'left',
                    formatter: function (value, row, index) {
                        var actions = [];
                        if (row.status == 1 || row.status == 7) {
                            //已经保存或者未被撤回的可以编辑/删除/提交
                            actions.push(' <a class="btn btn-info btn-xs ' + addFlag + '" href="#" onclick="submit(\'' + row.id + '\')"><i class="fa fa fa-send"></i> 提交</a> ');
                            actions.push(' <a class="btn btn-success btn-xs ' + editFlag + '" href="#" onclick="$.operate.editTab(\'' + row.id + '\')"><i class="fa fa-edit"></i> 编辑</a> ');
                        } else {
                            actions.push(' <a class="btn btn-info btn-xs ' + reviewFlag + '" href="javascript:void(0)" onclick="review(\'' + row.id + '\')"><i class="fa fa fa-check-square"></i> 审核</a> ');
                        }
                        actions.push(' <a class="btn btn-warning btn-xs ' + detailFlag + '" href="javascript:void(0)" onclick="detail(\'' + row.id + '\')"><i class="fa fa-search"></i> 详情</a> ');
                        /*if (row.status != 1) {
                            actions.push(' <a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="showHistoryDialog(\'' + row.id + '\')"><i class="fa fa-list-ul"></i> 历史</a> ');
                        }*/
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);
    });

    function onLoadSuccess(data) {
        $(".pie").peity("pie", {
            fill: ['#1ab394', '#d7d7d7', '#ffffff'],
        })
    }

    function batchReview() {
        table.set();
        var rows = $.common.isEmpty(table.options.uniqueId) ? $.table.selectFirstColumns() : $.table.selectColumns(table.options.uniqueId);
        if (rows.length == 0) {
            $.modal.alertWarning("请至少选择一条记录");
            return;
        }
        $.modal.confirm("确认要对选中的" + rows.length + "条数据执行批量审核操作吗?", function () {
            var ids = rows.join();
            var url = prefix + '/batchReview/' + ids;
            $.modal.open("批量审核", url, 500, 300);
        });
    }

    function fileList(id, flag) {
        var url = prefix + '/filePage/' + id + '/' + 2 + '/' + flag;
        $.modal.openFileList("File列表", url, null, null);
    }

    function detail(id) {
        // type:1 详情页 type:2 打印页面
        var url = prefix + "/detail/" + id + "/" + 1;
        createMenuItem(url, "详情");
    }

    function submit(id) {
        $.modal.confirm("确定提交吗？", function() {
            $.ajax({
                //几个参数需要注意一下
                type: "GET",//方法类型
                url: prefix + "/submit?id=" + id,//url
                dataType: "json",//预期服务器返回的数据类型
                timeout:60000,
                beforeSend: function () {
                    $.modal.loading("正在提交,请稍等......");
                },
                success: function (result) {
                    $.modal.closeLoading();
                    $.table.refresh();
                },
                error : function(result) {
                    $.modal.msgError(result.msg);
                }
            });
        })
    }


    function review(id) {
        //首先进行校验是不是可以审核
        var forReviewUrl = 'system/requisition/forReview/' + id;//校验url
        var url = 'system/requisition/review/' + id;
        $.ajax({
            //几个参数需要注意一下
            type: "GET",//方法类型
            url: ctx + forReviewUrl,//url
            dataType: "json",//预期服务器返回的数据类型
            timeout:60000,
            success: function (result) {
                if(result.code == 500){
                    $.modal.alertError(result.msg);
                    return false;
                }else{
                    createMenuItem(url, "审核"); 
                }
            },
            error : function() {
                alert("error！");
            }
        });
    }

    function typeTools(row) {
        if (row.typeOfApplication == 1) {
            return '非销售性请购'
        } else if (row.typeOfApplication == 2){
            return '固定资产'
        }
    }

    /* 状态显示 */
    function statusTools(row) {
        if (row.status == 1) {
            return '已保存待提交'
        }else if (row.status == 2){
            return '待主管审批'
        }else if (row.status == 23){
            return '待经理审批'
        }else if (row.status == 24){
            return '待总监审批'
        }else if (row.status == 25){
            return '待执行总监审批'
        }else if(row.status == 13){
            return '待资产管理员审批'
        }else if(row.status == 20){
            return '待采购代表审批'
        }else if (row.status == 16){
            return '待新员工入职HR审批'
        }else if(row.status == 19){
            return '待HR审批'
        }else if(row.status == 14){
            return '待预算管理员审批'
        }else if(row.status == 27){
            return '待财务预算经理审批'
        }else if (row.status == 3){
            return '待总账审批'
        }else if (row.status == 11){
            return '待财务经理审批'
        }else if(row.status == 4){
            return '待总经理审批'
        }else if(row.status == 18){
            return '待前加签审批'
        }else if(row.status == 26){
            return '待后加签审批'
        }else if(row.status == 22){
            return '保留'
        }else if(row.status == 5){
            return '完成'
        }else if(row.status == 6){
            return '否决'
        }else if(row.status == 7){
            return '撤回'
        }
    }

</script>
</body>
</html>