<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head >
    <th:block th:include="include :: header('日期和时间')" />
    <th:block th:include="include :: layout-latest-css" />
</head>
<body class="gray-bg">
<div class="container-div">
    <div class="row">
        <input type="hidden" id="paymentRequestId" name="paymentRequestId" th:value="${paymentRequestId}">
        <input type="hidden" id="status" th:value="${status}">
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table"></table>
        </div>
    </div>
    <div class="btn-group-sm" id="toolbar" role="group">
        <a class="btn btn-success" onclick="addFile()">
            <i class="fa fa-plus"></i> 添加
        </a>
    </div>
</div>
<th:block th:include="include :: footer" />
<script th:inline="javascript">
    var prefix = ctx + "system/paymentRequest";
    var comprefix = ctx + "common";
    $(function() {
        var options = {
            url: prefix + "/filePageList",
            queryParams: queryParams,
            columns: [
                {
                    field : 'id',
                    title : 'Id',
                    visible: true
                },
                {
                    field : 'fileName',
                    title : '文件名'
                },
                {
                    title : '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="downloadFaReport(\'' + escape(row.filePath) + '\',\'' + escape(row.fileName) + '\')"><i class="fa fa-download"></i>下载</a> ');
                        var status = $('#status').val();
                        if ( [[${flag}]]){
                            actions.push('<a class="btn btn-danger btn-xs" href="javascript:void(0)" onclick="deleteFaReport(\'' + row.id + '\',\'' + escape(row.filePath) + '\')"><i class="fa fa-remove"></i>删除</a>');
                        }
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);
    });

    function queryParams(params) {
        var search = $.table.queryParams(params);
        search.paymentRequestId = $("#paymentRequestId").val();
        //文件类型 11使用文档, 1请款单附件
        search.type = [[${type}]];
        return search;
    }
    // 下载文件
    function downloadFaReport(path,name) {
        window.location.href = comprefix + "/download/resources?fileName=" + unescape(name) + "&resource=" + unescape(path);
    }

    // 删除文件
    function deleteFaReport(id,file) {
        $.modal.confirm("确定删除该文件吗？", function() {
            var data = {"id": id, "filePath": unescape(file)}
            $.ajax({
                //几个参数需要注意一下
                type: "POST",//方法类型
                url: comPrefix + "/remove/file",//url
                data: data,
                dataType: "json",//预期服务器返回的数据类型
                timeout: 60000,
                success: function (result) {
                    if (result.code == web_status.SUCCESS) {
                        $.modal.msgSuccess(result.msg);
                        $.table.refresh();
                    } else if (result.code == web_status.WARNING) {
                        $.modal.alertWarning(result.msg)
                    } else {
                        $.modal.alertError(result.msg);
                    }
                }
            });
        });
    }

    // 上传文件
    // function addFile() {
    //     var paymentRequestId = $("#paymentRequestId").val();
    //     var url = prefix + '/addFile/' + paymentRequestId;
    //     $.modal.open("上传文件", url,500,200);
    // }

    function addFile() {
        var userName = [[${@permission.getPrincipalProperty('userName')}]];
        //文件类型 11使用文档, 1请款单附件
        var type = [[${type}]];
        if (type == 11 && userName != 'admin'){
            return $.modal.msgWarning("非管理员无法上传使用说明文档");
        }
        var currentId = 'importTpl';
        layer.open({
            type: 1,
            area: ['400px', '230px'],
            fix: false,
            //不固定
            maxmin: true,
            shade: 0.3,
            title: '上传文件',
            content: $('#' + currentId).html(),
            btn: ['<i class="fa fa-check"></i> 上传', '<i class="fa fa-remove"></i> 取消'],
            // 弹层外区域关闭
            shadeClose: true,
            btn1: function (index, layero) {
                $.modal.disable();
                var formData = new FormData();
                formData.append('files', $('#file')[0].files[0]);
                //文件类型 11使用文档, 1请款单附件
                var type = [[${type}]];
                if (type === 1){
                    formData.append('parentId', [[${paymentRequestId}]]);
                }
                formData.append('type', type);
                $.ajax({
                    url: ctx + "common/uploadFiles",
                    data: formData,
                    cache: false, //是否在缓存中读取数据，只针对get方式生效
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    dataType: "json",
                    success: function (result) {
                        if (result.code == web_status.SUCCESS) {
                            $.modal.msgSuccess(result.msg);
                            location.reload();
                        } else if (result.code == web_status.WARNING) {
                            $.modal.alertWarning(result.msg)
                        }  else {
                            $.modal.alertError(result.msg);
                        }
                        $.modal.closeLoading();
                        $.modal.enable();
                    }
                });
            }
        });
    }
</script>
<!-- 上传文件区域 -->
<script id="importTpl" type="text/template">
    <form enctype="multipart/form-data" class="mt20 mb10">
        <div class="col-xs-offset-1">
            <input type="file" id="file" name="file"/>
            <font color="red" class="pull-left mt10">
                <!--                提示：仅允许导入“ppt”、“pdf”或“word”格式文件！-->
                <br>
            </font>
        </div>
    </form>
</script>
</body>
</html>