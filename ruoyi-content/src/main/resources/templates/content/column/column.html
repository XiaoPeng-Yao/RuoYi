<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('栏目列表')"/>
</head>
<body class="gray-bg">
<div class="container-div">
    <div class="row">
        <div class="col-sm-12 search-collapse">
            <form id="formId">
                <div class="select-list">
                    <ul>
                        <li>
                            <label style="width: 95px;">一级栏目名称：</label>
                            <select name="codeType" th:id="codeType">

                            </select>
                        </li>
                        <li>
                            <label style="width: 95px;">二级栏目名称：</label>
                            <input type="text" name="codeCname"/>
                        </li>
                        <li>
                            <label>展示序号：</label>
                            <input type="text" name="orderNo"/>
                        </li>
                        <li>
                            <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i
                                    class="fa fa-search"></i>&nbsp;搜索</a>
                            <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i
                                    class="fa fa-refresh"></i>&nbsp;重置</a>
                            <a class="btn btn-success btn-rounded btn-sm" data-toggle="modal" data-target="#myModal2"
                               onclick="">
                                <i class="fa fa-plus"></i> 添加
                            </a>
                        </li>
                    </ul>
                </div>
            </form>
        </div>
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table"></table>
        </div>
    </div>
</div>
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header" style="border-bottom: 0px solid #e5e5e5;">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span>
                </button>
                <h5 class="modal-title" style="text-align: left;">添加栏目</h5>
            </div>
            <div class="modal-body" style="background: #ffffff;">
                <form class="form-horizontal m" id="form-picAdverts-add">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label">选择栏目所在公司：</label>
                            <div class="col-sm-8">
                                <select class="form-control" th:id="branchId" name="branchId"></select>
                            </div>
                        </div>
                        <div id="articleRadio">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">栏目层级：</label>
                                <div class="col-sm-8">
                                    <select class="form-control" name="sencondType" th:id="sencondType"
                                            th:onchange="changeTab()">
                                        <option value="sec">新建二级栏目</option>
                                        <option value="thr">新建三级栏目</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="addSecColumn">
                            <div class="form-group">
                                <label class="col-sm-4 control-label is-required">一级栏目名称：</label>
                                <div class="col-sm-8">
                                    <select th:id="codeTypes" name="codeTypes" class="form-control"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label is-required">二级栏目名称：</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" th:id="codeCnames" name="codeCnames">
                                </div>
                            </div>
                            <div class="form-group" style="display:none">
                                <label class="col-sm-4 control-label">展示序号:</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" th:id="orderNos" name="orderNos" value="1"/>
                                    <label class="red">序号越小，展示越靠前。</label>
                                </div>
                            </div>
                        </div>
                        <div id="addThirdColumn" style="display:none">
                            <div class="form-group">
                                <label class="col-sm-4 control-label is-required">一级栏目名称：</label>
                                <div class="col-sm-8">
                                    <select class="form-control">
                                        <option>文库</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="articleSelect">
                                <label class="col-sm-4 control-label is-required">选择二级栏目：</label>
                                <div class="col-sm-8">
                                    <select th:id="selectSec" class="form-control" name="selectSec"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label is-required">三级栏目名称：</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" th:id="thirdCodeCnames" name="thirdCodeCnames">
                                </div>
                                <br/><br/><br/>
                                <div class="form-group" style="display:none">
                                    <label class="col-sm-4 control-label">三级展示序号:</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" th:id="thirdOrderNos" name="thirdOrderNos"
                                               value="1" style="width:210px"/>
                                        <label class="red">序号越小，展示越靠前。</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 0px solid #e5e5e5;">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" th:onclick="addColumn()">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal" id="myModal3" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header" style="border-bottom: 0px solid #e5e5e5;">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span>
                </button>
                <h5 class="modal-title" style="text-align: left;">修改栏目</h5>
            </div>
            <div class="modal-body" style="background: #ffffff;">
                <form class="form-horizontal m" id="form-picAdverts-edit">
                    <input th:hidden="true" name="asdid" th:id="asdid">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">栏目所在公司：</label>
                            <div class="col-sm-6">
                                <select class="form-control" th:id="branchIdEdit" name="branchIdEdit"></select>
                            </div>
                        </div>
                        <div class="form-group" style="display:none" id="secSelect">
                            <label class="col-sm-4 control-label">所属栏目:</label>
                            <div class="col-sm-6">
                                <select class="selectpicker form-control" th:id="cType" name="cType"></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-4 control-label is-required">栏目名称:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" th:id="cName" name="cName"/>
                            </div>
                        </div>
                        <div class="form-group" style="display:none">
                            <label class="col-sm-4 control-label">展示序号:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" th:id="cOrderNo" name="cOrderNo"/>
                                <label class="red">序号越小，展示越靠前。</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 0px solid #e5e5e5;">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" th:onclick="editColum()">确定</button>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    var prefix = ctx + 'column';
    var prefix1 = ctx + 'ldcom/queryldcomList';
    var prefix2 = ctx + 'column/addColumn';

    var baseDataList = [];
    var articleSecList = [];
    var companyList = [];

    var isClick = false;

    $(function () {
        var options = {
            url: prefix + "/columnArry",
            createUrl: prefix + "/add",
            updateUrl: prefix + "/edit/{id}",
            removeUrl: prefix + "/delColumn",
            exportUrl: prefix + "/export",
            uniqueId: "id",
            modalName: "栏目",
            columns: [{
                checkbox: true
            },
                {
                    field: 'id',
                    title: '主键ID',
                    visible: false
                },
                {
                    field: 'codeCode',
                    title: 'code代码',
                    visible: false
                },
                {
                    field: 'codeType',
                    title: '上级栏目名称',
                    formatter: function (value, row, index) {
                        const result = queryCnameByid(row.codeType);
                        if (result != null && result != '') {
                            return result;
                        } else {
                            return "无";
                        }
                    }
                },
                {
                    field: 'codeCname',
                    title: '栏目名称'
                },
                {
                    field: 'orderNo',
                    title: '展示序号'
                },
                {
                    field: 'codeEname',
                    title: '栏目英文名',
                    visible: false
                },
                {
                    field: 'codeTname',
                    title: '栏目繁体名',
                    visible: false
                },
                {
                    field: 'state',
                    title: '状态',
                    formatter: function (value, row, index) {
                        if (row.state == '0') {
                            return '展示';
                        } else {
                            return '不展示';
                        }
                    }
                },
                {
                    field: 'createUser',
                    title: '创建者',
                    formatter: function (value, row, index) {
                        if (row.createUser == null || row.createUser == '') {
                            return '无';
                        } else {
                            return row.createUser;
                        }
                    }
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    formatter: function (value, row, index) {
                        if (row.createTime == null || row.createTime == '') {
                            return '无';
                        } else {
                            return row.createTime;
                        }
                    }
                },
                {
                    field: 'updateUser',
                    title: '修改者',
                    formatter: function (value, row, index) {
                        if (row.updateUser == null || row.updateUser == '') {
                            return '无';
                        } else {
                            return row.updateUser;
                        }
                    }
                },
                {
                    field: 'updateTime',
                    title: '修改时间',
                    formatter: function (value, row, index) {
                        if (row.updateTime == null || row.updateTime == '') {
                            return '无';
                        } else {
                            return row.updateTime;
                        }
                    }
                },
                {
                    title: '操作',
                    align: 'center',
                    formatter: function (value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-success btn-xs" data-toggle="modal" data-target="#myModal3" onclick="updateColumn(\'' + row.id + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                        actions.push('<a class="btn btn-danger btn-xs" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a>');
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);

        getBaseCode("FIRST_COLUMN");
        setValueTolist();
        selectArticleSecColumn();
        queryCompany();
    });

    function changeTab() {
        var radioValue = $("#sencondType option:selected").val();
        if (radioValue == "sec") {
            $("#addSecColumn").show();
            $("#addThirdColumn").hide();
        } else {
            $("#addSecColumn").hide();
            $("#addThirdColumn").show();
            selectArticleSecColumn();
        }
    }

    function queryCompany() {
        $.ajax({
            type: "post",
            url: prefix1,
            data: {},
            async: false,
            success: function (data) {
                companyList = data.object.ldcomList;
                for (var i = 0; i < companyList.length; i++) {
                    $("#branchId").append(
                        "<option value='" + companyList[i].comcode + "'>"
                        + companyList[i].shortname + "</option>")
                }
            }

        })
    }

    // 查询一级栏目
    function getBaseCode(type) {
        $.ajax({
            type: "post",
            url: prefix + "/queryBasicData",
            data: {
                "bType": type
            },
            async: false,
            success: function (data) {
                if (data.result) {// 跳转到列表页面
                    var list = data.object.baseList;
                    for (var i = 0; i < list.length; i++) {
                        baseDataList.push(list[i]);
                    }
                } else {

                }
            }
        });
    }

    function selectArticleSecColumn() {
        $.ajax({
            url: prefix + "/columnArry",
            data: {
                "codeType": "ARTICLE",
                "pageSize": "1000",
                "pageNum": "1"
            },
            dataType: "json",
            async: false,
            type: "post",
            success: function (data) {
                if (data.rows != null && data.rows.length > 0) {
                    const dataRows = data.rows;
                    articleSecList = dataRows;
                    $("#selectSec").empty();

                    for (var i = 0; i < dataRows.length; i++) {
                        $("#selectSec").append("<option value='" + dataRows[i].codeCode + "'>" + dataRows[i].codeCname + "</option>");
                    }
                }
            }
        });
    }

    // 给下拉列表赋值
    function setValueTolist() {
        // 给搜索的下拉列表赋值
        $("#codeType option").remove();
        var obj = baseDataList;
        $("#codeType").append("<option value=''>请选择</option>");
        for (var i = 0; i < obj.length; i++) {
            $("#codeType").append(
                "<option value='" + obj[i].codeCode + "'>" + obj[i].codeCname
                + "</option>");
            $("#codeTypes").append(
                "<option value='" + obj[i].codeCode + "'>" + obj[i].codeCname
                + "</option>");
        }
    }

    // 一栏目显示名称
    function queryCnameByid(id) {
        if (baseDataList == null) {
            getBaseCode("FIRST_COLUMN");
        }
        if (queryCnameByid == null) {
            selectArticleSecColumn();
        }
        const list = baseDataList.length;
        for (var i = 0; i < list; i++) {
            if (id == baseDataList[i].codeCode) {
                return baseDataList[i].codeCname;
            }
        }
        const articleList = articleSecList.length;
        for (var i = 0; i < articleList; i++) {
            if (id == articleSecList[i].codeCode) {
                return "文库-" + articleSecList[i].codeCname;
            }
        }
    }

    function addColumn() {
        var branchId = $("#branchId").val();
        var radioValue = $("#sencondType option:selected").val();
        var codeType = $("#codeTypes").val();
        var codeCname = $("#codeCnames").val();
        var selectSec = $("#selectSec").val();
        var thirdCodeCnames = $("#thirdCodeCnames").val();
        if (isClick) {
            return false;
        }
        if (radioValue == "sec") {
            if (codeType == '' || codeType == null) {
                $.modal.alertSuccess("请选择一级栏目！");
                return false;
            }
            if (codeCname == '' || codeCname == null) {
                $.modal.alertSuccess("请填写二级栏目名称！");
                return false;
            }
        } else {
            if (selectSec == '' || selectSec == null) {
                $.modal.alertSuccess("请选择二级栏目！");
                return false;
            }
            if (thirdCodeCnames == '' || thirdCodeCnames == null) {
                $.modal.alertSuccess("请填写三级栏目！");
                return false;
            }
        }
        isClick = true;
        $.ajax({
            url: prefix2,
            data: {
                "branchId": branchId,
                "radioValue": radioValue,
                "codeType": codeType,
                "codeCname": codeCname,
                "selectSec": selectSec,
                "thirdCodeCnames": thirdCodeCnames
            },
            dataType: "json",
            type: "post",
            cache: false,
            success: function (data) {
                isClick = false;
                if (data.result) {
                    const code = {
                        'code': 0
                    };
                    $.operate.successCallback(code);
                } else {
                    $.modal.alertSuccess(data.info);
                }
            },
            error: function (textStatus, e) {
                isClick = false;
                $.modal.alertSuccess('系统异常,请稍后重试!');
            }
        });
    };

    function updateColumn(id) {
        $('#asdid').val(id);
        var rowData = $("#" + table.options.id).bootstrapTable('getRowByUniqueId', id);
        $("#cName").val(rowData.codeCname);
        $("#cOrderNo").val(rowData.orderNo);
        // 处理公司下拉框
        $("#branchIdEdit option").remove();
        $.ajax({
            type: "post",
            url: prefix1,
            data: {},
            async: false,
            success: function (data) {
                var obj = data.object.ldcomList;

                for (var i = 0; i < obj.length; i++) {
                    if (obj[i].comcode == rowData.branchId) {
                        $("#branchIdEdit").append(
                            "<option selected=\"true\" value='"
                            + obj[i].comcode + "'>" + obj[i].shortname
                            + "</option>");
                    } else {
                        $("#branchIdEdit").append(
                            "<option value='" + obj[i].comcode + "'>"
                            + obj[i].shortname + "</option>")
                    }
                }
            }

        })

        // 处理一级栏目下拉
        $("#cType option").remove();
        var objc = [];
        if (rowData.codeType.indexOf("文库-") == -1) {
            $("#secSelect").hide();
            objc = baseDataList;
            for (var i = 0; i < objc.length; i++) {
                var codeType = rowData.codeType;
                if (objc[i].codeCname == codeType) {
                    $("#cType").append(
                        "<option selected=\"true\" value='" + objc[i].codeCode
                        + "'>" + objc[i].codeCname + "</option>");
                } else {
                    $("#cType").append(
                        "<option value='" + objc[i].codeCode + "'>"
                        + objc[i].codeCname + "</option>");
                }
            }
        } else {
            objc = articleSecList;
            $("#secSelect").show();
            for (var i = 0; i < objc.length; i++) {
                var codeType = rowData.codeType.split("-")[1];
                if (objc[i].codeCname == codeType) {
                    $("#cType").append(
                        "<option selected=\"true\" value='" + objc[i].codeCode
                        + "'>" + objc[i].codeCname + "</option>");
                } else {
                    $("#cType").append(
                        "<option value='" + objc[i].codeCode + "'>"
                        + objc[i].codeCname + "</option>");
                }
            }
        }
    };

    // 编辑后保存操作
    function editColum() {
        debugger
        let id = $('#asdid').val();
        let rowData = $("#" + table.options.id).bootstrapTable('getRowByUniqueId', id);
        let cName = $("#cName").val();
        let cType = $("#cType").val();
        let branchIdEdit = $("#branchIdEdit").val();
        if (cName == null || cName == '') {
            $.modal.alertSuccess("请输入二级栏目名称");
            return;
        }

        $.ajax({
            url: prefix + "/updateColumn",
            data: {
                "id": rowData.id,
                "codeType": cType,
                "branchId": branchIdEdit,
                "codeCname": cName,
                "codeCode": rowData.codeCode,
                "codeEname": rowData.codeEname,
                "codeTname": rowData.codeTname,
                "createTime": rowData.createTime,
                "createUser": rowData.createUser,
                "companyId": rowData.companyId,
                "state": rowData.state
            },
            dataType: "json",
            type: "post",
            cache: false,
            success: function (data) {
                if (data.result) {
                    const code = {
                        'code': 0
                    };
                    $.operate.successCallback(code);
                } else {
                    $.modal.alertSuccess(data.info);
                }
            },
            error: function (textStatus, e) {
                $.modal.alertSuccess('系统异常,请稍后重试!');
            }
        });
    }

</script>
</body>
</html>